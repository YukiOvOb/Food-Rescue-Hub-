name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - "development/Sprint2"
      - "feature/**"
      - "main"
  pull_request:
    branches:
      - main

permissions:
  contents: read

env:
  # "true" = report-only (lint won't fail pipeline)
  # "false" = strict gate (lint will fail)
  REPORT_ONLY: "true"

jobs:
  # ============================
  # STAGE 1: Checks (parallel)
  # ============================

  backend-tests:
    name: JUnit (Backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run backend tests
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw test

  # ----------------------------
  # React Lint (keep earlier stable version)
  # ----------------------------
  frontend-react-lint:
    name: Lint (React)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        working-directory: frontend
        run: npm ci

      # âœ… Create lint report even if ESLint fails
      - name: Run ESLint (report)
        working-directory: frontend
        run: |
          npx eslint "src/**/*.{js,jsx}" -f json -o eslint-report.json || true

      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: react-eslint-report
          path: frontend/eslint-report.json
          if-no-files-found: warn

  thymeleaf-template-lint:
    name: Lint (Thymeleaf Templates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install HTMLHint
        run: npm i -g htmlhint

      - name: Run HTMLHint on templates
        run: htmlhint "backend/src/main/resources/templates/**/*.html"

  # ----------------------------
  # Snyk (use the "correct working" format from your Feature vs Main file)
  # ----------------------------
  security_snyk:
    name: Snyk (SCA + SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write

    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Verify SNYK_TOKEN
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          fi

      - name: Setup Snyk
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      # ---- SAST (Snyk Code) -> SARIF
      - name: Snyk Code (SAST) + SARIF
        run: |
          set +e
          snyk code test
          SAST_EXIT=$?

          snyk code test --sarif --sarif-file-output=snyk-code.sarif 2>&1
          SARIF_EXIT=$?

          if [ "${REPORT_ONLY}" != "true" ] && [ $SAST_EXIT -ne 0 ]; then
            exit $SAST_EXIT
          fi
          exit 0

      - name: Upload Snyk SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      - name: Upload Snyk SARIF as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sarif
          path: snyk-code.sarif
          if-no-files-found: warn

      # ---- SCA backend
      - name: Snyk Open Source (SCA) - backend
        run: |
          cd backend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --file=pom.xml --severity-threshold=high || true
          else
            snyk test --file=pom.xml --severity-threshold=high
          fi

      # ---- SCA frontend
      - name: Snyk Open Source (SCA) - frontend
        run: |
          cd frontend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --severity-threshold=high || true
          else
            snyk test --severity-threshold=high
          fi

  # ----------------------------
  # CodeQL (kept from your pipeline-format file, with Java build)
  # ----------------------------
  sast-codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript"]
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Set up JDK 17 (for Java CodeQL)
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build backend (required for Java CodeQL)
        if: matrix.language == 'java'
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean install -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # ============================
  # STAGE 2A: Feature branch path
  # ============================

  docker-build-validate:
    name: Docker Build (Feature Branch Validation)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-react-lint, thymeleaf-template-lint, security_snyk, sast-codeql]
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build backend image (no push)
        run: docker build -t frh-backend:ci ./backend

      - name: Build frontend image (no push)
        run: docker build -t frh-frontend:ci -f frontend/Dockerfile .

  # ============================
  # STAGE 2B: Main branch path
  # ============================

  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-react-lint, thymeleaf-template-lint, security_snyk, sast-codeql]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest

      - name: Build & push frontend (nginx image with static assets)
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest -f frontend/Dockerfile .
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest

  docker-image-scan:
    name: Docker Image Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Scan backend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-backend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  iast:
    name: IAST (Main only)
    runs-on: ubuntu-latest
    needs: [docker-image-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: |
          echo "TODO: Add IAST tool steps"

  sit:
    name: SIT (Main only)
    runs-on: ubuntu-latest
    needs: [iast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: |
          echo "TODO: Add SIT tests here"

  dast:
    name: DAST (Main only)
    runs-on: ubuntu-latest
    needs: [sit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: |
          echo "TODO: Add OWASP ZAP DAST workflow here"

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [dast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/Food-Rescue-Hub-
            docker compose pull
            docker compose up -d
            docker system prune -f
