name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      # Feature / dev patterns (you requested development/sprint2/** style)
      - "development/sprint2/**"
      - "development/Sprint2"
      - "feature/**"
      - "main"
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  # "true" = report-only (lint/security won't fail pipeline)
  # "false" = strict gate (fail pipeline on issues)
  REPORT_ONLY: "true"

  # Optional: where your python ML code lives (adjust if needed)
  PYTHON_DIR: "ml"

  # Optional: where your android project lives (adjust if needed)
  ANDROID_DIR: "android"

  # Optional: URLs used by main-branch security checks (set as GitHub Secrets ideally)
  # STAGING_URL should be a reachable URL for ZAP/k6/nmap (e.g., http://xx.xx.xx.xx:8080)
  STAGING_URL: ${{ secrets.STAGING_URL }}

jobs:
  # ============================
  # STAGE 1: Feature/Dev checks
  # (run on feature/** and development/sprint2/** and development/Sprint2)
  # ============================

  backend-junit:
    name: Unit Tests (Java Backend) + JaCoCo
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run unit tests + generate coverage (Maven)
        working-directory: backend
        run: |
          chmod +x mvnw
          # "test" = unit tests; "verify" may include integration tests if configured
          # For feature/dev we keep this as unit-level unless your pom triggers IT.
          ./mvnw -q clean test

      - name: Upload Maven test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-unit-test-reports
          path: |
            backend/target/surefire-reports/**
          if-no-files-found: warn

      - name: Upload JaCoCo report (if present)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: |
            backend/target/site/jacoco/**
          if-no-files-found: warn

  python-tests:
    name: Unit Tests (Python ML) + Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python deps (if ML folder exists)
        run: |
          if [ -d "${PYTHON_DIR}" ]; then
            cd "${PYTHON_DIR}"
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            elif [ -f "pyproject.toml" ]; then
              pip install .
            else
              echo "No requirements.txt / pyproject.toml found in ${PYTHON_DIR}. Skipping deps."
            fi
            pip install pytest pytest-cov
          else
            echo "Python dir ${PYTHON_DIR} not found. Skipping."
          fi

      - name: Run pytest + coverage (if tests exist)
        run: |
          if [ -d "${PYTHON_DIR}" ]; then
            cd "${PYTHON_DIR}"
            if ls -1 test* tests* >/dev/null 2>&1; then
              pytest -q --junitxml=pytest-junit.xml --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov || \
              ( [ "${REPORT_ONLY}" = "true" ] && exit 0 || exit 1 )
            else
              echo "No Python tests folder found. Skipping pytest."
            fi
          fi

      - name: Upload pytest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-reports
          path: |
            ml/pytest-junit.xml
            ml/coverage.xml
            ml/htmlcov/**
          if-no-files-found: warn

  lint-code-quality:
    name: Lint & Code Quality (Java + Python + React + Thymeleaf + Kotlin/Android)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ---------- Java Checkstyle ----------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Backend - Checkstyle (report-only controlled)
        working-directory: backend
        run: |
          chmod +x mvnw
          if [ "${REPORT_ONLY}" = "true" ]; then
            ./mvnw -q checkstyle:check || true
          else
            ./mvnw -q checkstyle:check
          fi

      - name: Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-checkstyle-report
          path: |
            backend/target/checkstyle-result.xml
            backend/target/site/checkstyle.html
            backend/target/site/checkstyle.xml
          if-no-files-found: warn

      # ---------- Python Lint (flake8) ----------
      - name: Set up Python (for lint)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Python - flake8 (if ML folder exists)
        run: |
          if [ -d "${PYTHON_DIR}" ]; then
            pip install flake8
            cd "${PYTHON_DIR}"
            if [ "${REPORT_ONLY}" = "true" ]; then
              flake8 . --statistics --count --exit-zero --output-file=flake8-report.txt
            else
              flake8 . --statistics --count --output-file=flake8-report.txt
            fi
          else
            echo "Python dir ${PYTHON_DIR} not found. Skipping flake8."
          fi

      - name: Upload flake8 report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-flake8-report
          path: |
            ml/flake8-report.txt
          if-no-files-found: warn

      # ---------- React ESLint ----------
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend - Install deps
        working-directory: frontend
        run: npm ci

      - name: Frontend - ESLint report (always produce report)
        working-directory: frontend
        run: |
          npx eslint "src/**/*.{js,jsx}" -f json -o eslint-report.json || true

      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: react-eslint-report
          path: frontend/eslint-report.json
          if-no-files-found: warn

      # ---------- Thymeleaf templates HTMLHint ----------
      - name: Install HTMLHint
        run: npm i -g htmlhint

      - name: Thymeleaf - HTMLHint
        run: |
          if [ "${REPORT_ONLY}" = "true" ]; then
            htmlhint "backend/src/main/resources/templates/**/*.html" > htmlhint-report.txt || true
          else
            htmlhint "backend/src/main/resources/templates/**/*.html" > htmlhint-report.txt
          fi

      - name: Upload HTMLHint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: thymeleaf-htmlhint-report
          path: htmlhint-report.txt
          if-no-files-found: warn

      # ---------- Kotlin/Android lint ----------
      - name: Android - Lint (Kotlin)
        run: |
          if [ -d "${ANDROID_DIR}" ]; then
            cd "${ANDROID_DIR}"
            chmod +x gradlew
            if [ "${REPORT_ONLY}" = "true" ]; then
              ./gradlew lint || true
            else
              ./gradlew lint
            fi
          else
            echo "Android dir ${ANDROID_DIR} not found. Skipping Android lint."
          fi

      - name: Upload Android lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-report
          path: |
            android/**/build/reports/lint-results*.html
            android/**/build/reports/lint-results*.xml
          if-no-files-found: warn

  sca-snyk:
    name: SCA (Snyk Open Source) - Java + Python + JS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify SNYK_TOKEN
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          fi

      - name: Setup Snyk
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      - name: SCA - Java (Maven backend)
        run: |
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --file=backend/pom.xml --severity-threshold=high || true
          else
            snyk test --file=backend/pom.xml --severity-threshold=high
          fi

      - name: SCA - React (npm)
        run: |
          cd frontend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --severity-threshold=high || true
          else
            snyk test --severity-threshold=high
          fi

      - name: SCA - Python (requirements/pyproject if present)
        run: |
          if [ -d "${PYTHON_DIR}" ]; then
            cd "${PYTHON_DIR}"
            if [ "${REPORT_ONLY}" = "true" ]; then
              snyk test --severity-threshold=high || true
            else
              snyk test --severity-threshold=high
            fi
          else
            echo "Python dir ${PYTHON_DIR} not found. Skipping Snyk Python SCA."
          fi

  sast-codeql:
    name: SAST (CodeQL) - Java + JavaScript + Python
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript", "python"]
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Set up JDK 17 (for Java CodeQL)
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build backend (required for Java CodeQL)
        if: matrix.language == 'java'
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw -q clean install -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"