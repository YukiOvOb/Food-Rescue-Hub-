name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - "development/sprint2/**"
      - "development/Sprint2"
      - "feature/**"
      - "main"
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  REPORT_ONLY: "true"
  PYTHON_DIR: "ml"
  ANDROID_DIR: "android"

jobs:
  # ==========================================================
  # STAGE 0: Detect which parts exist (so we can skip safely)
  # ==========================================================
  detect:
    name: Detect project folders
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      has_thymeleaf: ${{ steps.detect.outputs.has_thymeleaf }}
      has_android: ${{ steps.detect.outputs.has_android }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_python_src: ${{ steps.detect.outputs.has_python_src }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        run: |
          # backend
          if [ -d "backend" ] && [ -f "backend/pom.xml" ]; then echo "has_backend=true" >> $GITHUB_OUTPUT; else echo "has_backend=false" >> $GITHUB_OUTPUT; fi

          # frontend
          if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then echo "has_frontend=true" >> $GITHUB_OUTPUT; else echo "has_frontend=false" >> $GITHUB_OUTPUT; fi

          # thymeleaf templates
          if ls backend/src/main/resources/templates/**/*.html >/dev/null 2>&1; then echo "has_thymeleaf=true" >> $GITHUB_OUTPUT; else echo "has_thymeleaf=false" >> $GITHUB_OUTPUT; fi

          # android
          if [ -d "${ANDROID_DIR}" ] && [ -f "${ANDROID_DIR}/build.gradle" -o -f "${ANDROID_DIR}/build.gradle.kts" -o -f "${ANDROID_DIR}/settings.gradle" -o -f "${ANDROID_DIR}/settings.gradle.kts" ]; then
            echo "has_android=true" >> $GITHUB_OUTPUT
          else
            echo "has_android=false" >> $GITHUB_OUTPUT
          fi

          # python folder
          if [ -d "${PYTHON_DIR}" ]; then echo "has_python=true" >> $GITHUB_OUTPUT; else echo "has_python=false" >> $GITHUB_OUTPUT; fi

          # python .py files (for CodeQL python)
          if [ -d "${PYTHON_DIR}" ] && find "${PYTHON_DIR}" -type f -name "*.py" | grep -q .; then
            echo "has_python_src=true" >> $GITHUB_OUTPUT
          else
            echo "has_python_src=false" >> $GITHUB_OUTPUT
          fi

  # ==========================================================
  # STAGE 1: Unit tests + Lint + SCA + SAST (feature/dev/main)
  # ==========================================================
  backend-junit:
    name: Unit Tests (Java Backend) + JaCoCo
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.has_backend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run unit tests + coverage
        working-directory: backend
        run: |
          chmod +x mvnw
          ./mvnw -q clean test

      - name: Upload Maven test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-unit-test-reports
          path: backend/target/surefire-reports/**
          if-no-files-found: warn

      - name: Upload JaCoCo report (if present)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: backend/target/site/jacoco/**
          if-no-files-found: warn

  python-tests:
    name: Unit Tests (Python ML) + Coverage
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.has_python == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          set -e
          cd "${PYTHON_DIR}"
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            pip install .
          else
            echo "No requirements.txt / pyproject.toml found — skipping dependency install"
          fi

      - name: Run pytest (only if tests exist)
        run: |
          cd "${PYTHON_DIR}"
          if ls -1 tests test* >/dev/null 2>&1; then
            pytest -q \
              --junitxml=pytest-junit.xml \
              --cov=. \
              --cov-report=xml:coverage.xml \
              --cov-report=html:htmlcov || \
            ( [ "${REPORT_ONLY}" = "true" ] && exit 0 || exit 1 )
          else
            echo "No Python tests found — skipping pytest"
          fi

      - name: Upload pytest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-reports
          path: |
            ml/pytest-junit.xml
            ml/coverage.xml
            ml/htmlcov/**
          if-no-files-found: warn

  lint-code-quality:
    name: Lint & Code Quality (Java + Python + React + Thymeleaf + Android)
    runs-on: ubuntu-latest
    needs: [detect]
    steps:
      - uses: actions/checkout@v4

      # ---------- Java Checkstyle ----------
      - name: Set up JDK 17
        if: needs.detect.outputs.has_backend == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Backend - Checkstyle
        if: needs.detect.outputs.has_backend == 'true'
        working-directory: backend
        run: |
          chmod +x mvnw
          if [ "${REPORT_ONLY}" = "true" ]; then
            ./mvnw -q checkstyle:check || true
          else
            ./mvnw -q checkstyle:check
          fi

      - name: Upload Checkstyle Report
        if: needs.detect.outputs.has_backend == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-checkstyle-report
          path: |
            backend/target/checkstyle-result.xml
            backend/target/site/checkstyle.html
            backend/target/site/checkstyle.xml
          if-no-files-found: warn

      # ---------- Python flake8 ----------
      - name: Set up Python (lint)
        if: needs.detect.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Python - flake8
        if: needs.detect.outputs.has_python == 'true'
        run: |
          pip install flake8
          cd "${PYTHON_DIR}"
          if [ "${REPORT_ONLY}" = "true" ]; then
            flake8 . --statistics --count --exit-zero --output-file=flake8-report.txt
          else
            flake8 . --statistics --count --output-file=flake8-report.txt
          fi

      - name: Upload flake8 report
        if: needs.detect.outputs.has_python == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: python-flake8-report
          path: ml/flake8-report.txt
          if-no-files-found: warn

      # ---------- React ESLint ----------
      - name: Setup Node 20
        if: needs.detect.outputs.has_frontend == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend - Install deps
        if: needs.detect.outputs.has_frontend == 'true'
        working-directory: frontend
        run: npm ci

      - name: Frontend - ESLint report
        if: needs.detect.outputs.has_frontend == 'true'
        working-directory: frontend
        run: |
          npx eslint "src/**/*.{js,jsx}" -f json -o eslint-report.json || true

      - name: Upload ESLint report
        if: needs.detect.outputs.has_frontend == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: react-eslint-report
          path: frontend/eslint-report.json
          if-no-files-found: warn

      # ---------- Thymeleaf HTMLHint ----------
      - name: Install HTMLHint
        if: needs.detect.outputs.has_thymeleaf == 'true'
        run: npm i -g htmlhint

      - name: Thymeleaf - HTMLHint
        if: needs.detect.outputs.has_thymeleaf == 'true'
        run: |
          if [ "${REPORT_ONLY}" = "true" ]; then
            htmlhint "backend/src/main/resources/templates/**/*.html" > htmlhint-report.txt || true
          else
            htmlhint "backend/src/main/resources/templates/**/*.html" > htmlhint-report.txt
          fi

      - name: Upload HTMLHint report
        if: needs.detect.outputs.has_thymeleaf == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: thymeleaf-htmlhint-report
          path: htmlhint-report.txt
          if-no-files-found: warn

      # ---------- Android Lint ----------
      - name: Android - Lint
        if: needs.detect.outputs.has_android == 'true'
        run: |
          cd "${ANDROID_DIR}"
          chmod +x gradlew
          if [ "${REPORT_ONLY}" = "true" ]; then
            ./gradlew lint || true
          else
            ./gradlew lint
          fi

      - name: Upload Android lint reports
        if: needs.detect.outputs.has_android == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-report
          path: |
            android/**/build/reports/lint-results*.html
            android/**/build/reports/lint-results*.xml
          if-no-files-found: warn

  sca-snyk:
    name: SCA (Snyk Open Source) - Java + Python + JS
    runs-on: ubuntu-latest
    needs: [detect]
    permissions:
      contents: read
      actions: read
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify SNYK_TOKEN
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          fi

      - name: Setup Snyk
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      - name: SCA - Java
        if: needs.detect.outputs.has_backend == 'true'
        run: |
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --file=backend/pom.xml --severity-threshold=high || true
          else
            snyk test --file=backend/pom.xml --severity-threshold=high
          fi

      - name: SCA - React
        if: needs.detect.outputs.has_frontend == 'true'
        run: |
          cd frontend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --severity-threshold=high || true
          else
            snyk test --severity-threshold=high
          fi

      - name: SCA - Python
        if: needs.detect.outputs.has_python == 'true'
        run: |
          cd "${PYTHON_DIR}"
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --severity-threshold=high || true
          else
            snyk test --severity-threshold=high
          fi

  sast-codeql:
    name: SAST (CodeQL) - Java + JavaScript (+ Python if present)
    runs-on: ubuntu-latest
    needs: [detect]
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript"]
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Set up JDK 17 (for Java)
        if: matrix.language == 'java' && needs.detect.outputs.has_backend == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build backend (required for Java CodeQL)
        if: matrix.language == 'java' && needs.detect.outputs.has_backend == 'true'
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw -q clean install -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  sast-codeql-python:
    name: SAST (CodeQL) - Python (only if Python source exists)
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.has_python_src == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis (Python)
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # ==========================================================
  # STAGE 2: Integration Tests (only on development/Sprint2)
  # ==========================================================
  integration-tests:
    name: Integration Tests (development/Sprint2)
    runs-on: ubuntu-latest
    needs:
      - detect
      - backend-junit
      - python-tests
      - lint-code-quality
      - sca-snyk
      - sast-codeql
      - sast-codeql-python
    if: github.event_name == 'push' && github.ref == 'refs/heads/development/Sprint2'
    steps:
      - uses: actions/checkout@v4

      - name: Start stack (Docker Compose)
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for backend
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/api/hello >/dev/null; then
              echo "Backend is up"
              exit 0
            fi
            echo "Waiting for backend... ($i)"
            sleep 5
          done
          echo "Backend did not become ready"
          docker compose logs --no-color
          exit 1

      - name: Functional integration smoke (API)
        run: curl -fsS http://localhost:8080/api/hello

      - name: Newman API tests (optional)
        run: |
          if [ -f "tests/postman/collection.json" ]; then
            npm i -g newman
            newman run tests/postman/collection.json \
              --reporters cli,junit \
              --reporter-junit-export newman-junit.xml || \
              ( [ "${REPORT_ONLY}" = "true" ] && exit 0 || exit 1 )
          else
            echo "No Postman collection found at tests/postman/collection.json. Skipping."
          fi

      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: newman-junit.xml
          if-no-files-found: warn

      - name: Stop stack
        if: always()
        run: docker compose down -v

  # ==========================================================
  # STAGE 3: Main branch release
  # ==========================================================
  build-and-push:
    name: Build & Push Docker Images (main)
    runs-on: ubuntu-latest
    needs:
      - detect
      - backend-junit
      - python-tests
      - lint-code-quality
      - sca-snyk
      - sast-codeql
      - sast-codeql-python
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend
        if: needs.detect.outputs.has_backend == 'true'
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest

      - name: Build & push frontend
        if: needs.detect.outputs.has_frontend == 'true'
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest -f frontend/Dockerfile .
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest

  image-scan-trivy:
    name: Container Image Scan (Trivy) - main
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Scan backend image (Trivy)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-backend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - name: Scan frontend image (Trivy)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  # Optional main-only checks that need a reachable URL:
  port-scan-nmap:
    name: Port Scan (nmap) - main (optional)
    runs-on: ubuntu-latest
    needs: [image-scan-trivy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      STAGING_URL: ${{ secrets.STAGING_URL }}
    steps:
      - name: Skip if STAGING_URL not set
        run: |
          if [ -z "${STAGING_URL}" ]; then
            echo "STAGING_URL not set. Skipping nmap."
            exit 0
          fi

      - name: Install nmap
        run: sudo apt-get update && sudo apt-get install -y nmap

      - name: Run nmap
        run: |
          HOST=$(echo "${STAGING_URL}" | sed -E 's#https?://##' | sed -E 's#/.*##')
          echo "Scanning host: $HOST"
          nmap -sV -Pn -T3 "$HOST" -oN nmap-report.txt || true

      - name: Upload nmap report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nmap-report
          path: nmap-report.txt
          if-no-files-found: warn

  deploy:
    name: Deploy (EC2)
    runs-on: ubuntu-latest
    needs: [port-scan-nmap]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH (docker compose)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/Food-Rescue-Hub-
            docker compose pull
            docker compose up -d
            docker compose ps
            docker compose config >/dev/null
            docker system prune -f
