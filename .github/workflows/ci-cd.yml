name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - "development/Sprint2"
      - "development/Sprint2/**"
      - "feature/**"
      - "main"
  pull_request:
    branches:
      - "main"

permissions:
  contents: read

jobs:
  backend-tests:
    name: JUnit (Backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Run backend tests
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw test

  frontend-react-lint:
    name: Lint (React)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        working-directory: frontend
        run: npm ci

      - name: Run ESLint (fail only on errors)
        working-directory: frontend
        run: npx eslint "src/**/*.{js,jsx}" --max-warnings=9999

  thymeleaf-template-lint:
    name: Lint (Thymeleaf Templates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install HTMLHint
        run: npm i -g htmlhint

      - name: Run HTMLHint on templates
        run: htmlhint "backend/src/main/resources/templates/**/*.html"

  snyk:
    name: SCA/SAST (Snyk)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Check Snyk token exists
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          else
            echo "SNYK_TOKEN is set correctly"
          fi

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      - name: Snyk Dependency Test (SCA)
        run: |
          echo "==== Snyk Dependency Test (Backend Maven) ===="
          snyk test --file=backend/pom.xml || true

          echo "==== Snyk Dependency Test (Frontend npm) ===="
          (cd frontend && snyk test) || true
        continue-on-error: true

      - name: Snyk Code test (SAST) + SARIF
        run: |
          snyk code test || true
          snyk code test --sarif --sarif-file-output=snyk-code.sarif 2>&1 || true
          if [ -f snyk-code.sarif ]; then
            echo "SARIF created"
            ls -lh snyk-code.sarif
          else
            echo "SARIF not created"
          fi
        continue-on-error: true

      - name: Check if SARIF file exists
        id: check_sarif
        run: |
          if [ -f snyk-code.sarif ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: steps.check_sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      - name: Upload SARIF as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sarif
          path: snyk-code.sarif
          if-no-files-found: warn

  sast-codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript"]
    steps:
      - uses: actions/checkout@v4

      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - uses: github/codeql-action/analyze@v3

  docker-build-validate:
    name: Docker Build (Feature Branch Validation)
    runs-on: ubuntu-latest
    needs:
      - backend-tests
      - frontend-react-lint
      - thymeleaf-template-lint
      - snyk
      - sast-codeql
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build backend image (no push)
        run: docker build -t frh-backend:ci ./backend

      - name: Build frontend image (no push)
        run: docker build -t frh-frontend:ci ./frontend

  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs:
      - backend-tests
      - frontend-react-lint
      - thymeleaf-template-lint
      - snyk
      - sast-codeql
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest

      - name: Build & push frontend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest ./frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest

  docker-image-scan:
    name: Docker Image Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Scan backend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-backend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  iast:
     name: IAST (Main Only)
     runs-on: ubuntu-latest
     needs: [docker-image-scan]
     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
     steps:
      - name: IAST placeholder
        run: |
          echo "TODO: Add IAST tool steps"

  sit:
    name: SIT (Main Only)
    runs-on: ubuntu-latest
    needs: [iast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: SIT placeholder
        run: |
          echo "TODO: Add SIT tests"

  dast:
    name: DAST (Main Only)
    runs-on: ubuntu-latest
    needs: [sit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: DAST placeholder
        run: |
          echo "TODO: Add OWASP ZAP DAST"
