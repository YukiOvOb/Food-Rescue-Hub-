name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - main
      - Sprint2/**
      - feature/**
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: frh-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

env:
  PYTHON_DIR: ml
  ANDROID_DIR: android
  BACKEND_LOCAL_URL: "http://localhost:8081"
  OPENAPI_PATH: "/v3/api-docs"
  SMOKE_PATH: "/api/hello"

# =========================================================
# STAGE 0: Detect modules
# =========================================================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_compose: ${{ steps.detect.outputs.has_compose }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          echo "has_backend=$(test -f backend/pom.xml && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_frontend=$(test -f frontend/package.json && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_python=$(test -d ml && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_compose=$(test -f docker-compose.yml && echo true || echo false)" >> $GITHUB_OUTPUT

# =========================================================
# STAGE 1: Unit Tests + Coverage
# =========================================================
  backend-tests:
    needs: detect
    if: needs.detect.outputs.has_backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
          cache: maven
      - run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean test

# =========================================================
# STAGE 1: SAST (CodeQL)
# =========================================================
  sast-codeql:
    needs: backend-tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [java, javascript]
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/analyze@v3

# =========================================================
# STAGE 1: SCA + Secrets Scan (Trivy FS)
# =========================================================
  sca-trivy:
    needs: sast-codeql
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy.sarif
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif

# =========================================================
# STAGE 2: Integration Tests (Docker Compose)
# =========================================================
  integration-tests:
    needs: sca-trivy
    runs-on: ubuntu-latest
    if: needs.detect.outputs.has_compose == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: docker compose up -d
      - run: |
          for i in {1..30}; do
            curl -fsS "${BACKEND_LOCAL_URL}${SMOKE_PATH}" && exit 0
            sleep 5
          done
          exit 1
      - run: docker compose down -v

# =========================================================
# STAGE 3: Build & Push Docker Images
# =========================================================
  build-and-push:
    needs: integration-tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - run: docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-backend backend
      - run: docker push ${{ secrets.DOCKER_USERNAME }}/frh-backend

# =========================================================
# STAGE 3: IAST (MANDATORY â€“ Contrast)
# =========================================================
  iast-contrast:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      CONTRAST_API_URL: ${{ secrets.CONTRAST_API_URL }}
      CONTRAST_API_USER_NAME: ${{ secrets.CONTRAST_API_USER_NAME }}
      CONTRAST_API_KEY: ${{ secrets.CONTRAST_API_KEY }}
      CONTRAST_ORG_ID: ${{ secrets.CONTRAST_ORG_ID }}
      CONTRAST_APP_ID: ${{ secrets.CONTRAST_APP_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Contrast Secrets
        run: |
          test -n "$CONTRAST_API_URL"
          test -n "$CONTRAST_API_KEY"
      - name: IAST Explanation
        run: |
          echo "IAST enabled via Contrast agent attached to runtime"
          echo "Agent must be baked into Docker image or JVM args"

# =========================================================
# STAGE 3: Performance Testing (k6)
# =========================================================
  perf-k6:
    needs: iast-contrast
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y k6
      - run: |
          cat > k6.js <<'EOF'
          import http from 'k6/http';
          export default function () {
            http.get('${{ secrets.STAGING_URL }}');
          }
          EOF
          k6 run k6.js

# =========================================================
# STAGE 3: DAST (OWASP ZAP)
# =========================================================
  dast-zap:
    needs: perf-k6
    runs-on: ubuntu-latest
    steps:
      - run: |
          docker run --rm owasp/zap2docker-stable zap-baseline.py \
          -t ${{ secrets.STAGING_URL }} \
          -r zap.html || true

# =========================================================
# STAGE 4: Deploy to AWS EC2
# =========================================================
  deploy:
    needs: dast-zap
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/Food-Rescue-Hub-
            docker compose pull
            docker compose up -d
