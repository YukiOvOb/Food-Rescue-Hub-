name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - "development/Sprint2"
      - "development/sprint2/**"
      - "feature/**"
      - "main"
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

concurrency:
  group: frh-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REPORT_ONLY: "true"               # true = don't fail pipeline on scanners/lints; false = enforce gates
  PYTHON_DIR: "ml"
  ANDROID_DIR: "android"

  BACKEND_LOCAL_URL: "http://localhost:8080"
  OPENAPI_PATH: "/v3/api-docs"
  SMOKE_PATH: "/api/hello"

jobs:
  # =========================================================
  # STAGE 0: Detect folders
  # =========================================================
  detect:
    name: Detect project folders
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      has_python_src: ${{ steps.detect.outputs.has_python_src }}
      has_android: ${{ steps.detect.outputs.has_android }}
      has_compose: ${{ steps.detect.outputs.has_compose }}
      has_playwright: ${{ steps.detect.outputs.has_playwright }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        shell: bash
        run: |
          set -e

          if [ -f "backend/pom.xml" ]; then
            echo "has_backend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_backend=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -f "frontend/package.json" ]; then
            echo "has_frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_frontend=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -d "${PYTHON_DIR}" ] && find "${PYTHON_DIR}" -type f -name "*.py" | grep -q .; then
            echo "has_python_src=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_python_src=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -d "${ANDROID_DIR}" ] && [ -f "${ANDROID_DIR}/gradlew" ]; then
            echo "has_android=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_android=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -f "docker-compose.yml" ] || [ -f "compose.yml" ]; then
            echo "has_compose=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_compose=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -f "frontend/playwright.config.ts" ] || [ -f "frontend/playwright.config.js" ]; then
            echo "has_playwright=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_playwright=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Print flags
        run: |
          echo "has_backend=${{ steps.detect.outputs.has_backend }}"
          echo "has_frontend=${{ steps.detect.outputs.has_frontend }}"
          echo "has_python_src=${{ steps.detect.outputs.has_python_src }}"
          echo "has_android=${{ steps.detect.outputs.has_android }}"
          echo "has_compose=${{ steps.detect.outputs.has_compose }}"
          echo "has_playwright=${{ steps.detect.outputs.has_playwright }}"


  # =========================================================
  # STAGE 1: Unit tests - Java
  # =========================================================
  backend-junit:
    name: Unit Tests (Java Backend) + JaCoCo
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.has_backend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run tests
        working-directory: backend
        shell: bash
        run: |
          set -e
          chmod +x mvnw
          ./mvnw -q clean test

      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-unit-test-reports
          path: backend/target/surefire-reports/**
          if-no-files-found: warn

      - name: Upload JaCoCo report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: backend/target/site/jacoco/**
          if-no-files-found: warn


  # =========================================================
  # STAGE 1: Unit tests - Python (only if python exists)
  # =========================================================
  python-tests:
    name: Unit Tests (Python ML) + Coverage
    runs-on: ubuntu-latest
    needs: [detect]
    if: needs.detect.outputs.has_python_src == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        shell: bash
        run: |
          set -e
          cd "${PYTHON_DIR}"
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            pip install .
          fi
          pip install pytest pytest-cov

      - name: Run pytest
        shell: bash
        run: |
          set -e
          cd "${PYTHON_DIR}"
          if [ -d "tests" ] || ls -1 test* >/dev/null 2>&1; then
            pytest -q --junitxml=pytest-junit.xml --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov || \
              ( [ "${REPORT_ONLY}" = "true" ] && exit 0 || exit 1 )
          else
            echo "No Python tests found -> skipping"
          fi

      - name: Upload pytest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-reports
          path: |
            ml/pytest-junit.xml
            ml/coverage.xml
            ml/htmlcov/**
          if-no-files-found: warn


  # =========================================================
  # STAGE 1: SAST (CodeQL)
  # =========================================================
  sast-codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    needs: [detect]
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ["java", "javascript", "python"]
    steps:
      - uses: actions/checkout@v4

      - name: Skip python if no python src
        if: matrix.language == 'python' && needs.detect.outputs.has_python_src != 'true'
        run: exit 0

      - name: Initialize CodeQL
        if: matrix.language != 'python' || needs.detect.outputs.has_python_src == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Set up JDK 17 (Java only)
        if: matrix.language == 'java' && needs.detect.outputs.has_backend == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build backend for CodeQL (Java only)
        if: matrix.language == 'java' && needs.detect.outputs.has_backend == 'true'
        shell: bash
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw -q clean install -DskipTests

      - name: Analyze
        if: matrix.language != 'python' || needs.detect.outputs.has_python_src == 'true'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"


  # =========================================================
  # STAGE 1: Trivy FS (SCA + Secrets + Misconfig)
  # =========================================================
  sca-trivy-fs:
    name: Trivy FS (SCA + Secrets + Misconfig)
    runs-on: ubuntu-latest
    needs: [detect]
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Trivy FS scan -> SARIF
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs.sarif
          severity: HIGH,CRITICAL
          scanners: vuln,secret,config
          ignore-unfixed: true

      - name: Upload SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

      - name: Upload Trivy artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-sarif
          path: trivy-fs.sarif
          if-no-files-found: warn


  # =========================================================
  # STAGE 2: Integration Tests (Compose + Schemathesis)
  # =========================================================
  integration-tests:
    name: Integration Tests (Compose + Schemathesis)
    runs-on: ubuntu-latest
    needs: [detect, backend-junit, python-tests, sast-codeql, sca-trivy-fs]
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/development/Sprint2' || github.ref == 'refs/heads/main')) ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - uses: actions/checkout@v4

      - name: Skip if no compose
        if: needs.detect.outputs.has_compose != 'true'
        run: |
          echo "No docker-compose.yml/compose.yml -> skipping integration"
          exit 0

      - name: Start stack
        if: needs.detect.outputs.has_compose == 'true'
        shell: bash
        run: |
          set -e
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml up -d
            docker compose -f docker-compose.yml ps
          else
            docker compose -f compose.yml up -d
            docker compose -f compose.yml ps
          fi

      - name: Wait for backend
        if: needs.detect.outputs.has_compose == 'true'
        shell: bash
        run: |
          set -e
          for i in {1..60}; do
            if curl -fsS "${BACKEND_LOCAL_URL}${SMOKE_PATH}" >/dev/null 2>&1; then
              echo "Backend is up"
              exit 0
            fi
            echo "Waiting... ($i)"
            sleep 5
          done
          echo "Backend not ready"
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml logs --no-color
          else
            docker compose -f compose.yml logs --no-color
          fi
          exit 1

      - name: Setup Python (Schemathesis)
        if: needs.detect.outputs.has_compose == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Schemathesis (Swagger/OpenAPI auto API tests)
        if: needs.detect.outputs.has_compose == 'true'
        shell: bash
        run: |
          set -e
          pip install "schemathesis>=3,<4"
          OPENAPI_URL="${BACKEND_LOCAL_URL}${OPENAPI_PATH}"
          echo "OpenAPI = ${OPENAPI_URL}"

          schemathesis run "${OPENAPI_URL}" \
            --base-url "${BACKEND_LOCAL_URL}" \
            --checks all \
            --junit-xml schemathesis-junit.xml || \
            ( [ "${REPORT_ONLY}" = "true" ] && exit 0 || exit 1 )

      - name: Upload Schemathesis report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schemathesis-report
          path: schemathesis-junit.xml
          if-no-files-found: warn

      - name: Stop stack
        if: always() && needs.detect.outputs.has_compose == 'true'
        shell: bash
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml down -v
          else
            docker compose -f compose.yml down -v
          fi


  # =========================================================
  # STAGE 2.5: "IAST-like" Security test in CI (ZAP Automation)
  # Runs scanner against local running app while stack is up
  # =========================================================
  iast-zap:
    name: IAST-style Security Test (ZAP Automation)
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/development/Sprint2' || github.ref == 'refs/heads/main')) ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - uses: actions/checkout@v4

      - name: Skip if no compose
        if: ${{ !hashFiles('docker-compose.yml') && !hashFiles('compose.yml') }}
        run: |
          echo "No compose file -> skipping ZAP"
          exit 0

      - name: Start stack
        shell: bash
        run: |
          set -e
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml up -d
          else
            docker compose -f compose.yml up -d
          fi

      - name: Wait for backend
        shell: bash
        run: |
          set -e
          for i in {1..60}; do
            if curl -fsS "${BACKEND_LOCAL_URL}${SMOKE_PATH}" >/dev/null 2>&1; then
              echo "Backend is up"
              exit 0
            fi
            sleep 5
          done
          echo "Backend not ready"
          exit 1

      - name: Create ZAP automation file
        shell: bash
        run: |
          cat > zap-automation.yaml <<'EOF'
          env:
            contexts:
              - name: "frh"
                urls:
                  - "http://host.docker.internal:8080"
            parameters:
              failOnError: false
              failOnWarning: false
          jobs:
            - type: spider
              parameters:
                context: "frh"
                url: "http://host.docker.internal:8080"
                maxDuration: 2
            - type: passiveScan-wait
              parameters:
                maxDuration: 2
            - type: activeScan
              parameters:
                context: "frh"
                policy: "Default Policy"
                maxRuleDurationInMins: 2
            - type: report
              parameters:
                template: "traditional-html"
                reportDir: "/zap/wrk"
                reportFile: "zap-report.html"
          EOF

      - name: Run ZAP Automation (active security scan)
        shell: bash
        run: |
          set -e
          docker run --rm -t \
            -v "$(pwd)":/zap/wrk \
            --add-host=host.docker.internal:host-gateway \
            owasp/zap2docker-stable zap.sh -cmd -autorun /zap/wrk/zap-automation.yaml || true

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-iast-style-report
          path: zap-report.html
          if-no-files-found: warn

      - name: Stop stack
        if: always()
        shell: bash
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml down -v
          else
            docker compose -f compose.yml down -v
          fi


  # =========================================================
  # STAGE 3: Build & Push (main only)
  # =========================================================
  build-and-push:
    name: Build & Push Docker Images (main)
    runs-on: ubuntu-latest
    needs: [detect, integration-tests, iast-zap]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Skip if Docker secrets missing
        shell: bash
        run: |
          if [ -z "${DOCKER_USERNAME}" ] || [ -z "${DOCKER_PASSWORD}" ]; then
            echo "Docker secrets missing -> skipping build & push"
            exit 0
          fi

      - name: Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend
        if: needs.detect.outputs.has_backend == 'true'
        shell: bash
        run: |
          set -e
          docker build -t "${DOCKER_USERNAME}/frh-backend:latest" ./backend
          docker push "${DOCKER_USERNAME}/frh-backend:latest"

      - name: Build & push frontend
        if: needs.detect.outputs.has_frontend == 'true'
        shell: bash
        run: |
          set -e
          docker build -t "${DOCKER_USERNAME}/frh-frontend:latest" -f frontend/Dockerfile .
          docker push "${DOCKER_USERNAME}/frh-frontend:latest"


  # =========================================================
  # STAGE 4: Deploy (main only)
  # =========================================================
  deploy:
    name: Deploy (EC2)
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
    steps:
      - name: Skip if EC2 secrets missing
        shell: bash
        run: |
          if [ -z "${EC2_HOST}" ] || [ -z "${EC2_SSH_KEY}" ]; then
            echo "EC2 secrets missing -> skipping deploy"
            exit 0
          fi

      - name: Deploy via SSH (docker compose)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/Food-Rescue-Hub-
            docker compose pull
            docker compose up -d
            docker compose ps
            docker system prune -f
