name: Food Rescue Hub CI/CD

on:
  push:
    branches:
      - "development/Sprint2"
      - "development/Sprint2/**"
      - "feature/**"
      - "main"
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  # ----------------------------
  # 1) BACKEND - JUnit Tests
  # ----------------------------
  backend-tests:
    name: JUnit (Backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Run backend tests
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw test

  # ----------------------------
  # 2) FRONTEND - React Lint
  # (fails only on ESLint errors; warnings allowed)
  # ----------------------------
  frontend-react-lint:
    name: Lint (React)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        working-directory: frontend
        run: npm ci

      - name: Run ESLint (warnings allowed)
        working-directory: frontend
        run: npx eslint "src/**/*.{js,jsx}" --max-warnings=9999

  # ----------------------------
  # 3) THYMELEAF TEMPLATE LINT
  # ----------------------------
  thymeleaf-template-lint:
    name: Lint (Thymeleaf Templates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install HTMLHint
        run: npm i -g htmlhint

      - name: Run HTMLHint on templates
        run: htmlhint "backend/src/main/resources/templates/**/*.html"

  # ----------------------------
  # 4) Snyk - SCA + SAST (SARIF)
  # ----------------------------
  snyk:
    name: SCA/SAST (Snyk)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Check Snyk token exists
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          else
            echo "SNYK_TOKEN is set correctly"
          fi

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      # Dependency scan (SCA) - do not break build (evidence only)
      - name: Snyk Dependency Test (SCA)
        run: |
          echo "==== Snyk Dependency Test (Backend Maven) ===="
          snyk test --file=backend/pom.xml || true

          echo "==== Snyk Dependency Test (Frontend npm) ===="
          (cd frontend && snyk test) || true
        continue-on-error: true

      # Code scan (SAST) + SARIF - do not break build (evidence only)
      - name: Snyk Code test (SAST) + Generate SARIF
        run: |
          echo "==== Snyk Code Test Results ===="
          snyk code test || true

          echo ""
          echo "==== Generating SARIF file ===="
          snyk code test --sarif --sarif-file-output=snyk-code.sarif 2>&1 || true

          echo ""
          echo "==== Checking if SARIF file exists ===="
          if [ -f snyk-code.sarif ]; then
            echo "✓ SARIF file created successfully"
            ls -lh snyk-code.sarif
          else
            echo "✗ SARIF file not created"
          fi
        continue-on-error: true

      - name: Check if SARIF file exists
        id: check_sarif
        run: |
          if [ -f snyk-code.sarif ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Snyk SARIF to GitHub Code Scanning
        if: steps.check_sarif.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      - name: Upload Snyk SARIF as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sarif
          path: snyk-code.sarif
          if-no-files-found: warn

  # ----------------------------
  # 5) CodeQL - SAST
  # supports: java, javascript
  # ----------------------------
  sast-codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ "java", "javascript" ]
    steps:
      - uses: actions/checkout@v4

      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - uses: github/codeql-action/analyze@v3

  # ----------------------------
  # 6) FEATURE/Sprint - Docker build validation (NO PUSH)
  # runs only on push events that are NOT main
  # ----------------------------
  docker-build-validate:
    name: Docker Build (Feature Branch Validation)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-react-lint, thymeleaf-template-lint, snyk, sast-codeql]
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build backend image (no push)
        run: docker build -t frh-backend:ci ./backend

      - name: Build frontend image (no push)
        run: docker build -t frh-frontend:ci ./frontend

  # ----------------------------
  # 7) MAIN ONLY - Build & Push Images
  # ----------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-react-lint, thymeleaf-template-lint, snyk, sast-codeql]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push backend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-backend:latest

      - name: Build & push frontend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest ./frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest

  # ----------------------------
  # 8) MAIN ONLY - Docker Image Scan (Trivy)
  # ----------------------------
  docker-image-scan:
    name: Docker Image Scan (Trivy)
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Scan backend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-backend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "${{ secrets.DOCKER_USERNAME }}/frh-frontend:latest"
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  # ----------------------------
  # 9) MAIN ONLY - IAST (placeholder)
  # ----------------------------
  iast:
    name: IAST (Main Only)
    runs-on: ubuntu-latest
    needs: [docker-image-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: echo "TODO: Add IAST steps (Contrast, Snyk IAST, etc.)"

  # ----------------------------
  # 10) MAIN ONLY - SIT (placeholder)
  # ----------------------------
  sit:
    name: SIT (Main Only)
    runs-on: ubuntu-latest
    needs: [iast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: echo "TODO: Add SIT tests (integration/API tests) here"

  # ----------------------------
  # 11) MAIN ONLY - DAST (placeholder)
  # ----------------------------
  dast:
    name: DAST (Main Only)
    runs-on: ubuntu-latest
    needs: [sit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - run: echo "TODO: Add OWASP ZAP DAST here"

  # ----------------------------
  # 12) MAIN ONLY - Deploy
  # ----------------------------
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [dast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /path/to/your/app
            docker compose pull
            docker compose up -d
