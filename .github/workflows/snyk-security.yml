name: CI/CD (Feature vs Main)

on:
  push:
    branches:
      - "**"          # all branches (includes feature/* and main)
  pull_request:
    branches:
      - "main"        # PRs targeting main
  workflow_dispatch:

permissions:
  contents: read

env:
  # Set to "false" when you want lint/security to become a hard gate
  REPORT_ONLY: "true"

jobs:
  # ---------------------------
  # 1) Unit tests (always on any push/PR)
  # ---------------------------
  junit_backend:
    name: JUnit (Backend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Run JUnit
        working-directory: backend
        run: |
          chmod +x mvnw
          ./mvnw test

  # ---------------------------
  # 2) Lint (always on any push/PR)
  # ---------------------------
  lint:
    name: Lint (Backend + Android + React + Thymeleaf)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Backend checkstyle
      - uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Backend - Checkstyle
        working-directory: backend
        run: |
          chmod +x mvnw
          ./mvnw -q checkstyle:check
        continue-on-error: ${{ env.REPORT_ONLY == 'true' }}

      - name: Upload Backend Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-checkstyle-report
          path: |
            backend/target/checkstyle-result.xml
            backend/target/site/checkstyle.html
            backend/target/site/checkstyle.xml
          if-no-files-found: warn

      # Android lint
      - name: Android - Lint
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew lint
        continue-on-error: ${{ env.REPORT_ONLY == 'true' }}

      - name: Upload Android Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-report
          path: |
            android/**/build/reports/lint-results*.html
            android/**/build/reports/lint-results*.xml
          if-no-files-found: warn

      # React eslint
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Frontend - Install deps
        working-directory: frontend
        run: npm ci

      - name: Frontend - ESLint report
        working-directory: frontend
        run: |
          npx eslint "src/**/*.{js,jsx}" -f json -o eslint-report.json
        continue-on-error: ${{ env.REPORT_ONLY == 'true' }}

      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: react-eslint-report
          path: frontend/eslint-report.json
          if-no-files-found: warn

      # Thymeleaf htmlhint
      - name: Install HTMLHint
        run: npm i -g htmlhint

      - name: Create HTMLHint config (Thymeleaf-safe)
        run: |
          cat > .htmlhintrc << 'EOF'
          {
            "tag-pair": true,
            "attr-lowercase": false,
            "attr-value-double-quotes": false,
            "doctype-first": false,
            "spec-char-escape": false,
            "id-unique": true,
            "attr-name-ignore-regex": "^(th:|xmlns:th)"
          }
          EOF

      - name: Thymeleaf - HTMLHint
        run: |
          htmlhint "backend/src/main/resources/templates/**/*.html" --config .htmlhintrc > htmlhint-report.txt
        continue-on-error: ${{ env.REPORT_ONLY == 'true' }}

      - name: Upload HTMLHint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: thymeleaf-htmlhint-report
          path: htmlhint-report.txt
          if-no-files-found: warn

  # ---------------------------
  # 3) SCA + SAST (always on any push/PR)
  # ---------------------------
  security_snyk:
    name: Snyk (SCA + SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write

    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Verify SNYK_TOKEN
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN is NOT set"
            exit 1
          fi

      - name: Setup Snyk
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      # ---- SAST (Snyk Code) -> SARIF
      - name: Snyk Code (SAST) + SARIF
        run: |
          set +e
          snyk code test
          SAST_EXIT=$?

          snyk code test --sarif --sarif-file-output=snyk-code.sarif 2>&1
          SARIF_EXIT=$?

          if [ "${REPORT_ONLY}" != "true" ] && [ $SAST_EXIT -ne 0 ]; then
            exit $SAST_EXIT
          fi
          exit 0

      - name: Upload Snyk SARIF to Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      # ---- SCA backend
      - name: Snyk Open Source (SCA) - backend
        run: |
          cd backend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --file=pom.xml --severity-threshold=high || true
          else
            snyk test --file=pom.xml --severity-threshold=high
          fi

      # ---- SCA frontend
      - name: Snyk Open Source (SCA) - frontend
        run: |
          cd frontend
          if [ "${REPORT_ONLY}" = "true" ]; then
            snyk test --severity-threshold=high || true
          else
            snyk test --severity-threshold=high
          fi

  # ==========================================================
  # MAIN-ONLY STAGES (only when branch == main)
  # ==========================================================

  # ---------------------------
  # 4) SIT (System Integration Tests) - main only
  # ---------------------------
  sit:
    name: SIT (Main only)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [junit_backend, lint, security_snyk]

    steps:
      - uses: actions/checkout@v4

      - name: Run SIT (placeholder)
        run: |
          echo "Run your SIT here (e.g., start services + run integration tests)"
          # Example:
          # docker compose up -d
          # ./backend/mvnw verify -Pintegration-tests

  # ---------------------------
  # 5) IAST - main only
  # ---------------------------
  iast:
    name: IAST (Main only)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [sit]

    steps:
      - uses: actions/checkout@v4

      - name: Run IAST (placeholder)
        run: |
          echo "IAST usually requires app running + agent (Contrast/Veracode/Seeker, etc.)"
          echo "Implement your IAST tool steps here."

  # ---------------------------
  # 6) DAST - main only
  # ---------------------------
  dast:
    name: DAST (Main only)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [iast]

    steps:
      - uses: actions/checkout@v4

      - name: DAST (OWASP ZAP baseline) - placeholder
        run: |
          echo "DAST requires a reachable URL."
          echo "Set APP_URL as a secret or env, then run ZAP against it."
          echo "Example only - will not scan without a real URL."

      # Example (uncomment when you have APP_URL):
      # - name: OWASP ZAP Baseline Scan
      #   env:
      #     APP_URL: ${{ secrets.APP_URL }}
      #   run: |
      #     docker run --rm -t owasp/zap2docker-stable zap-baseline.py \
      #       -t "$APP_URL" -r zap-report.html || true
      #
      # - name: Upload ZAP report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: zap-dast-report
      #     path: zap-report.html
