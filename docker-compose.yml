services:
  mysql:
    image: mysql:8.0
    container_name: frh-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Singapore
    ports:
      - "33306:3306"
    volumes:
      services:
        mysql:
          image: mysql:8.0
          container_name: frh-mysql
          restart: unless-stopped
          environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_DATABASE: ${MYSQL_DATABASE}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            TZ: Asia/Singapore
          ports:
            - "33306:3306"
          volumes:
            - mysql_data:/var/lib/mysql
          networks:
            - frh-net

        backend:
          image: "bhava0807/frh-backend:latest"
          container_name: frh-backend
          restart: unless-stopped
          environment:
            SPRING_PROFILES_ACTIVE: "prod" # Production
            SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Singapore"
            SPRING_DATASOURCE_USERNAME: "${MYSQL_USER}"
            SPRING_DATASOURCE_PASSWORD: "${MYSQL_PASSWORD}"
          ports:
            - "8081:8080"
          depends_on:
            - mysql
          networks:
            - frh-net

        frontend-build:
          build: ./frontend
          container_name: frh-frontend-build
          command: ["sh", "-c", "rm -rf /out/* && cp -r /app/dist/* /out/ && echo 'frontend build copied'"]
          volumes:
            - frontend_build:/out
          networks:
            - frh-net

        nginx:
          image: nginx:1.27-alpine
          container_name: frh-nginx
          restart: unless-stopped
          ports:
            - "8080:80"
          volumes:
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
            - frontend_build:/usr/share/nginx/html:ro
          depends_on:
            - backend
            - frontend-build
          networks:
            - frh-net

      volumes:
        mysql_data:
        frontend_build:

      networks:
        frh-net:

