<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Rescue Hub - Supplier Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #4CAF50; color: white; font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; transition: opacity 0.3s; }
        .btn:hover { opacity: 0.9; }
        .btn-confirm { background-color: #2196F3; color: white; }
        .btn-mock { background-color: #ff9800; color: white; }
        .btn-refresh { background-color: #607d8b; color: white; }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.85em; font-weight: bold; }
        .status-paid { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .status-completed { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

        /* æ§åˆ¶é¢æ¿ */
        .controls { margin-bottom: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 60px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸª Supplier Settlement Dashboard (ä¾›åº”å•†ç»“ç®—åå°)</h2>

    <div class="controls">
        <label>Store ID: <input type="number" id="storeIdInput" value="1"></label>

        <button onclick="loadOrders()" class="btn btn-refresh">ğŸ”„ Refresh List</button>

        <div style="flex-grow: 1;"></div> <button onclick="createMockOrder()" class="btn btn-mock">ğŸ›  Create Test Order (æ¨¡æ‹Ÿä¸‹å•)</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>Order ID</th>
            <th>Amount (SGD)</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="orderTableBody">
        <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // åç«¯ API åœ°å€
    const API_BASE = "http://localhost:8080/api/orders";

    // 1. åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
        const storeId = document.getElementById('storeIdInput').value;
        const tbody = document.getElementById('orderTableBody');

        try {
            const response = await fetch(`${API_BASE}/store/${storeId}`);

            if (!response.ok) {
                throw new Error("API Connection Failed");
            }

            const orders = await response.json();
            tbody.innerHTML = "";

            if (orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: #888;">No orders found for Store #${storeId}</td></tr>`;
                return;
            }

            // æŒ‰ ID å€’åºæ’åˆ—ï¼Œæ–°çš„åœ¨ä¸Šé¢
            orders.sort((a, b) => b.orderId - a.orderId);

            orders.forEach(order => {
                const isPaid = order.status === 'PAID';
                const statusClass = isPaid ? 'status-paid' : 'status-completed';

                const row = `
                    <tr>
                        <td>#${order.orderId}</td>
                        <td>$${order.totalAmount.toFixed(2)}</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.createdAt).toLocaleString()}</td>
                        <td>
                            ${isPaid
                                ? `<button class="btn btn-confirm" onclick="settleOrder(${order.orderId})">âœ… Confirm Pickup</button>`
                                : '<span style="color: green;">âœ” Completed</span>'}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error("Error loading orders:", error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">Failed to load orders. Is Backend running on port 8080?</td></tr>`;
        }
    }

    // 2. ç»“ç®—è®¢å• (ç¡®è®¤å–è´§)
    async function settleOrder(orderId) {
        if(!confirm(`Confirm pickup for Order #${orderId}?`)) return;

        try {
            const response = await fetch(`${API_BASE}/${orderId}/complete`, {
                method: 'PUT'
            });

            if (response.ok) {
                alert("Settlement Successful! äº¤æ˜“å®Œæˆï¼Œåº“å­˜å·²æ‰£é™¤ (é€»è¾‘ä¸Š)");
                loadOrders(); // åˆ·æ–°åˆ—è¡¨
            } else {
                const msg = await response.text();
                alert("Failed: " + msg);
            }
        } catch (error) {
            console.error(error);
            alert("Network Error");
        }
    }

    // 3. é€ å‡æ•°æ® (æ–¹ä¾¿æµ‹è¯•)
    async function createMockOrder() {
        const storeId = document.getElementById('storeIdInput').value;
        const userId = 1; // å‡è®¾ä½ çš„ DataInitializer åˆ›å»ºäº† ID ä¸º 1 çš„ User
        const randomPrice = (Math.random() * 20 + 5).toFixed(2);

        try {
            const res = await fetch(`${API_BASE}/mock?storeId=${storeId}&userId=${userId}&amount=${randomPrice}`, {
                method: 'POST'
            });

            if (res.ok) {
                const msg = await res.text();
                console.log(msg);
                loadOrders(); // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨çœ‹æ–°è®¢å•
            } else {
                alert("Mock creation failed. Check console.");
            }
        } catch (e) {
            alert("Backend not reachable.");
        }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
    loadOrders();
</script>

</body>
</html>